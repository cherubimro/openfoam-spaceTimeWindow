#!/bin/sh
cd "${0%/*}" || exit                                # Run from this directory
. ${WM_PROJECT_DIR:?}/bin/tools/RunFunctions        # Tutorial run functions
#------------------------------------------------------------------------------

# Check for 'doc' argument to build documentation only
if [ "$1" = "doc" ]; then
    echo "Building documentation..."

    # Build LaTeX tutorial if pdflatex is available
    if command -v pdflatex >/dev/null 2>&1; then
        echo "Building tutorial PDF..."
        cd doc
        pdflatex -interaction=nonstopmode tutorial.tex > /dev/null
        pdflatex -interaction=nonstopmode tutorial.tex > /dev/null
        cd ..
        echo "Tutorial built: doc/tutorial.pdf"
    else
        echo "Warning: pdflatex not found, skipping tutorial PDF"
    fi

    # Generate Doxygen HTML documentation if available
    if command -v doxygen >/dev/null 2>&1; then
        echo "Building Doxygen HTML documentation..."
        doxygen doc/Doxyfile
        echo "Doxygen documentation built: doc/html/index.html"
    else
        echo "Warning: doxygen not found, skipping HTML documentation"
    fi

    echo ""
    echo "Documentation build complete."
    exit 0
fi

# Check for libsodium (optional encryption support)
if pkg-config --exists libsodium 2>/dev/null; then
    echo "libsodium found - building with encryption support"
    export FOAM_USE_SODIUM=1
else
    echo "libsodium not found - building without encryption support"
    echo "  To enable encryption: install libsodium-dev (Debian/Ubuntu)"
    echo "                        or libsodium-devel (RHEL/Fedora)"
fi

# Check for libzstd (optional zstd compression support)
if pkg-config --exists libzstd 2>/dev/null; then
    echo "libzstd found - building with zstd compression support"
    export FOAM_USE_ZSTD=1
else
    echo "libzstd not found - building without zstd compression"
    echo "  To enable: install libzstd-dev (Debian/Ubuntu)"
    echo "             or libzstd-devel (RHEL/Fedora/SUSE)"
fi

# Build the spaceTimeWindow library (BC + function object)
echo ""
echo "Building spaceTimeWindow library..."
wmake src/spaceTimeWindow

# Build the spaceTimeWindowInitCase utility
echo ""
echo "Building spaceTimeWindowInitCase utility..."
wmake src/spaceTimeWindow/applications/utilities/preProcessing/spaceTimeWindowInitCase

# Build the spaceTimeWindowKeygen utility (only if encryption enabled)
if [ -n "$FOAM_USE_SODIUM" ]; then
    echo ""
    echo "Building spaceTimeWindowKeygen utility..."
    wmake src/spaceTimeWindow/applications/utilities/preProcessing/spaceTimeWindowKeygen
fi

# Build the pimpleFoamPrecise solver (registers HbyA for precise extraction)
echo ""
echo "Building pimpleFoamPrecise solver..."
wmake src/pimpleFoamPrecise

# Build the compareDvz utility (debug/testing tool)
echo ""
echo "Building compareDvz utility..."
wmake src/spaceTimeWindow/utilities/compareDvz

echo ""
echo "Build complete."
echo "Library: \$FOAM_USER_LIBBIN/libspaceTimeWindow.so"
echo "Utility: \$FOAM_USER_APPBIN/spaceTimeWindowInitCase"
echo "Utility: \$FOAM_USER_APPBIN/compareDvz"
echo "Solver:  \$FOAM_USER_APPBIN/pimpleFoamPrecise"
if [ -n "$FOAM_USE_SODIUM" ]; then
    echo "Utility: \$FOAM_USER_APPBIN/spaceTimeWindowKeygen"
    echo "Encryption: enabled"
else
    echo "Encryption: disabled (install libsodium to enable)"
fi
if [ -n "$FOAM_USE_ZSTD" ]; then
    echo "Zstd compression: enabled"
else
    echo "Zstd compression: disabled (install libzstd to enable)"
fi
echo ""
echo "To build documentation: ./Allwmake doc"

#------------------------------------------------------------------------------
